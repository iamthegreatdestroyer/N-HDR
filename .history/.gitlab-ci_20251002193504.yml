#
# HDR Empire Framework - GitLab CI/CD Pipeline
#
# Copyright (c) 2025 Stephen Bilodeau
# All rights reserved - Patent Pending
#
# This CI/CD pipeline automates testing, building, and deployment
# of the HDR Empire Framework to ensure enterprise-grade quality
# and rapid, reliable delivery.
#

# Define pipeline stages
stages:
  - test
  - build
  - deploy

# Global variables
variables:
  DOCKER_DRIVER: overlay2
  DOCKER_TLS_CERTDIR: "/certs"
  NODE_VERSION: "18"
  DOCKER_IMAGE_NAME: "hdr-empire"
  KUBERNETES_NAMESPACE: "hdr-production"

# Cache configuration for faster builds
cache:
  key:
    files:
      - package-lock.json
  paths:
    - node_modules/
    - .npm/

# ============================================================================
# TEST STAGE - Run comprehensive test suite with coverage
# ============================================================================

test:unit:
  stage: test
  image: node:${NODE_VERSION}-alpine
  before_script:
    - npm ci --cache .npm --prefer-offline
  script:
    - echo "Running unit tests..."
    - npm run test:unit -- --coverage --maxWorkers=2
  coverage: '/All files[^|]*\|[^|]*\s+([\d\.]+)/'
  artifacts:
    reports:
      coverage_report:
        coverage_format: cobertura
        path: coverage/cobertura-coverage.xml
      junit: junit.xml
    paths:
      - coverage/
    expire_in: 7 days
  rules:
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
    - if: '$CI_COMMIT_BRANCH == "main"'
    - if: '$CI_COMMIT_BRANCH == "develop"'

test:integration:
  stage: test
  image: node:${NODE_VERSION}-alpine
  before_script:
    - npm ci --cache .npm --prefer-offline
  script:
    - echo "Running integration tests..."
    - npm run test:integration -- --maxWorkers=2
  artifacts:
    reports:
      junit: junit.xml
    when: always
    expire_in: 7 days
  rules:
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
    - if: '$CI_COMMIT_BRANCH == "main"'
    - if: '$CI_COMMIT_BRANCH == "develop"'
  allow_failure: false

test:performance:
  stage: test
  image: node:${NODE_VERSION}-alpine
  before_script:
    - npm ci --cache .npm --prefer-offline
  script:
    - echo "Running performance tests..."
    - npm run test:performance -- --maxWorkers=1
  artifacts:
    paths:
      - performance-results/
    when: always
    expire_in: 7 days
  rules:
    - if: '$CI_COMMIT_BRANCH == "main"'
    - if: '$CI_COMMIT_BRANCH == "develop"'
  allow_failure: true

# ============================================================================
# BUILD STAGE - Create Docker image with proper tagging
# ============================================================================

build:docker:
  stage: build
  image: docker:24-dind
  services:
    - docker:24-dind
  before_script:
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
  script:
    - echo "Building Docker image for HDR Empire Framework..."
    - |
      docker build \
        --build-arg NODE_VERSION=${NODE_VERSION} \
        --build-arg BUILD_DATE=$(date -u +'%Y-%m-%dT%H:%M:%SZ') \
        --build-arg VCS_REF=${CI_COMMIT_SHORT_SHA} \
        --build-arg VERSION=${CI_COMMIT_TAG:-${CI_COMMIT_SHORT_SHA}} \
        -t ${CI_REGISTRY_IMAGE}:${CI_COMMIT_SHORT_SHA} \
        -t ${CI_REGISTRY_IMAGE}:latest \
        -f Dockerfile .
    - docker push ${CI_REGISTRY_IMAGE}:${CI_COMMIT_SHORT_SHA}
    - docker push ${CI_REGISTRY_IMAGE}:latest
    - echo "Docker image built and pushed successfully"
    - echo "Image tag: ${CI_COMMIT_SHORT_SHA}"
  rules:
    - if: '$CI_COMMIT_BRANCH == "main"'
    - if: '$CI_COMMIT_BRANCH == "develop"'
    - if: "$CI_COMMIT_TAG"
  dependencies:
    - test:unit
    - test:integration

build:docker:tagged:
  stage: build
  image: docker:24-dind
  services:
    - docker:24-dind
  before_script:
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
  script:
    - echo "Building tagged release for version ${CI_COMMIT_TAG}..."
    - |
      docker build \
        --build-arg NODE_VERSION=${NODE_VERSION} \
        --build-arg BUILD_DATE=$(date -u +'%Y-%m-%dT%H:%M:%SZ') \
        --build-arg VCS_REF=${CI_COMMIT_SHA} \
        --build-arg VERSION=${CI_COMMIT_TAG} \
        -t ${CI_REGISTRY_IMAGE}:${CI_COMMIT_TAG} \
        -t ${CI_REGISTRY_IMAGE}:stable \
        -f Dockerfile .
    - docker push ${CI_REGISTRY_IMAGE}:${CI_COMMIT_TAG}
    - docker push ${CI_REGISTRY_IMAGE}:stable
  rules:
    - if: '$CI_COMMIT_TAG =~ /^v[0-9]+\.[0-9]+\.[0-9]+$/'
  dependencies:
    - test:unit
    - test:integration

# ============================================================================
# DEPLOY STAGE - Deploy to Kubernetes environments
# ============================================================================

.deploy_template: &deploy_template
  image: bitnami/kubectl:latest
  before_script:
    - echo "Configuring kubectl..."
    - kubectl config set-cluster k8s --server="${KUBE_URL}"
    - kubectl config set clusters.k8s.certificate-authority-data ${KUBE_CA_CERT}
    - kubectl config set-credentials gitlab --token="${KUBE_TOKEN}"
    - kubectl config set-context default --cluster=k8s --user=gitlab --namespace=${KUBERNETES_NAMESPACE}
    - kubectl config use-context default
    - kubectl version --client
  script:
    - echo "Deploying HDR Empire Framework to ${CI_ENVIRONMENT_NAME}..."
    - echo "Using image tag: ${CI_COMMIT_SHORT_SHA}"
    # Update image tag in Kubernetes manifests
    - sed -i "s|IMAGE_TAG|${CI_COMMIT_SHORT_SHA}|g" k8s/deployment.yaml
    - sed -i "s|NAMESPACE|${KUBERNETES_NAMESPACE}|g" k8s/*.yaml
    # Apply Kubernetes manifests
    - kubectl apply -f k8s/namespace.yaml
    - kubectl apply -f k8s/configmap.yaml
    - kubectl apply -f k8s/secrets.yaml
    - kubectl apply -f k8s/deployment.yaml
    - kubectl apply -f k8s/service.yaml
    - kubectl apply -f k8s/ingress.yaml
    - kubectl apply -f k8s/hpa.yaml
    # Wait for rollout to complete
    - kubectl rollout status deployment/hdr-empire -n ${KUBERNETES_NAMESPACE} --timeout=5m
    # Verify deployment
    - kubectl get pods -n ${KUBERNETES_NAMESPACE} -l app=hdr-empire
    - kubectl get services -n ${KUBERNETES_NAMESPACE} -l app=hdr-empire
    - echo "Deployment completed successfully"
  dependencies:
    - build:docker

deploy:staging:
  <<: *deploy_template
  stage: deploy
  environment:
    name: staging
    url: https://staging.hdr-empire.local
    on_stop: stop:staging
  variables:
    KUBERNETES_NAMESPACE: "hdr-staging"
  rules:
    - if: '$CI_COMMIT_BRANCH == "develop"'
      when: on_success
  allow_failure: false

deploy:production:
  <<: *deploy_template
  stage: deploy
  environment:
    name: production
    url: https://hdr-empire.local
    on_stop: stop:production
  variables:
    KUBERNETES_NAMESPACE: "hdr-production"
  rules:
    - if: '$CI_COMMIT_BRANCH == "main"'
      when: manual
  allow_failure: false

# Stop environment jobs
stop:staging:
  stage: deploy
  image: bitnami/kubectl:latest
  variables:
    GIT_STRATEGY: none
    KUBERNETES_NAMESPACE: "hdr-staging"
  script:
    - echo "Stopping staging environment..."
    - kubectl delete all -l app=hdr-empire -n ${KUBERNETES_NAMESPACE}
  environment:
    name: staging
    action: stop
  rules:
    - if: '$CI_COMMIT_BRANCH == "develop"'
      when: manual

stop:production:
  stage: deploy
  image: bitnami/kubectl:latest
  variables:
    GIT_STRATEGY: none
    KUBERNETES_NAMESPACE: "hdr-production"
  script:
    - echo "Stopping production environment..."
    - kubectl delete all -l app=hdr-empire -n ${KUBERNETES_NAMESPACE}
  environment:
    name: production
    action: stop
  rules:
    - if: '$CI_COMMIT_BRANCH == "main"'
      when: manual

# ============================================================================
# ADDITIONAL JOBS - Security scanning, linting, etc.
# ============================================================================

security:scan:
  stage: test
  image: node:${NODE_VERSION}-alpine
  before_script:
    - npm ci --cache .npm --prefer-offline
  script:
    - echo "Running security audit..."
    - npm audit --audit-level=moderate || true
    - echo "Checking for vulnerabilities..."
  artifacts:
    reports:
      dependency_scanning: gl-dependency-scanning-report.json
    when: always
    expire_in: 7 days
  rules:
    - if: '$CI_COMMIT_BRANCH == "main"'
    - if: '$CI_COMMIT_BRANCH == "develop"'
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
  allow_failure: true

lint:code:
  stage: test
  image: node:${NODE_VERSION}-alpine
  before_script:
    - npm ci --cache .npm --prefer-offline
  script:
    - echo "Running code linting..."
    - npm run lint || true
  rules:
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
    - if: '$CI_COMMIT_BRANCH == "main"'
    - if: '$CI_COMMIT_BRANCH == "develop"'
  allow_failure: true
